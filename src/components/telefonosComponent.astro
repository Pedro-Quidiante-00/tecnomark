---
import { fetchFromAPI } from '../lib/conections.ts';

interface Props {
    titulo: string;
}
const { titulo } = Astro.props;

// 1. Obtenemos y filtramos los datos (Ya tenías bien el filtro 'telefonos')
const data = await fetchFromAPI('productos');
const productos = Array.isArray(data)
    ? data.filter((item: any) => item.categoria === 'telefonos')
    : [];

// 2. FUNCIÓN MODIFICADA: Adaptada para especificaciones de celulares
const getKeyDetails = (prod: any) => {
    const detalles = prod.detalles || {};

    // Definimos qué campos buscar para un teléfono.
    // Nota: Asegúrate de que estos nombres (pantalla, almacenamiento, etc.)
    // coincidan con los nombres de tus campos en el JSON/Strapi.
    const specs = [
        { label: 'Pantalla', value: detalles.pantalla },
        { label: 'Almacenamiento', value: detalles.almacenamiento }, // Ej: 128GB
        { label: 'RAM', value: detalles.ram },                       // Ej: 8GB
        { label: 'Batería', value: detalles.bateria },               // Ej: 5000mAh
        { label: 'Cámara', value: detalles.camara || detalles.camara_principal }
    ];

    // Filtramos los que no tengan valor y tomamos solo los primeros 3 para no romper el diseño
    return specs.filter(d => d.value).slice(0, 3);
};
---

<section class="py-12">
    <h2 class="text-3xl font-bold uppercase text-black mb-8 text-center">{titulo}</h2>

    <div class="w-8xl mx-auto px-10 grid grid-cols-1 md:grid-cols-3 gap-6 pb-8">

        {productos.slice(0, 5).map((prod: any) => {
            // A. IMAGEN: Prioridad a Cloudinary (image.url), respaldo a tu url manual
            const img = prod.image?.url || prod.imagen_url;

            // B. Obtener los detalles clave usando la función nueva
            const keyDetails = getKeyDetails(prod);

            return (
                    <div class="group w-full border border-gray-200 hover:shadow-xl transition-shadow duration-300 rounded-lg overflow-hidden bg-white p-4 flex flex-col">
                        <a href={`/producto/${prod.slug}`} class="block h-full flex-grow">

                            {/* Contenedor Imagen */}
                            <div class="h-56 w-full bg-white flex items-center justify-center p-4 relative mb-4">
                                <img
                                        src={img}
                                        alt={prod.nombre}
                                        class="h-full w-full object-contain group-hover:scale-110 transition-transform duration-300"
                                />
                                {/* Etiqueta flotante (Marca o SO) */}
                                <span class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">
                                {prod.marca || prod.tipo || 'Smartphone'}
                            </span>
                            </div>

                            {/* Información */}
                            <div class="text-center">
                                {/* Nombre del producto */}
                                <h3 class="text-sm font-semibold text-gray-900 leading-tight line-clamp-2 h-10 mb-2">
                                    {prod.nombre}
                                </h3>

                                {/* Precio */}
                                <div class="mb-4">
                                    <p class="text-2xl font-extrabold text-gray-900">
                                        $ {Number(prod.precio).toLocaleString('es-CL')}
                                    </p>
                                </div>
                            </div>
                        </a>

                        {/* Lista de Especificaciones */}
                        <div class="mt-auto pt-4 border-t border-gray-100 text-sm text-gray-700 space-y-1.5">
                            {keyDetails.map((detail, index) => (
                                    <p key={index} class="flex justify-between">
                                        <span class="font-bold">{detail.label}:</span>
                                        <span class="text-gray-600">{detail.value}</span>
                                    </p>
                            ))}
                            {/* Fallback si no hay detalles */}
                            {keyDetails.length === 0 && (
                                    <p class="text-xs text-gray-400 italic text-center">Ver detalles en el producto</p>
                            )}
                        </div>
                    </div>
            );
        })}

        {productos.length === 0 && (
                <p class="text-center col-span-3 text-gray-500">No hay teléfonos disponibles por ahora.</p>
        )}
    </div>
</section>